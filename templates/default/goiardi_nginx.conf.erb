upstream goiardi {
  server unix:<%= node['goiardi']['webui']['deploy_location'] %>/shared/sockets/puma.sock fail_timeout=0;
}

# TODO: also configure for SSL.
server {
  <% if node['goiardi']['use_ssl'] -%>
  listen <%= node['goiardi']['webui']['port'] %>;
  listen <%= node['goiardi']['webui']['ssl_port'] %> default ssl;
  <% else -%>
  listen <%= node['goiardi']['webui']['port'] %> default deferred;
  <% end -%>
  server_name <%= node['goiardi']['webui']['server_name'] %>;

  <% if node['goiardi']['use_ssl'] %>
  ssl_certificate <%= node['goiardi']['ssl_cert_filename'] %>;
  ssl_certificate_key <%= node['goiardi']['ssl_key_filename'] %>;
  if ($ssl_protocol = "") {
    rewrite ^   https://$server_name$request_uri? permanent;
  }
  <% end %>
  # allow only valid crud methods
  if ($request_method !~ GET|POST|PUT|DELETE|PATCH) {
    return 405;
  }

  # ignore obviously false requests
  if ($request_filename ~ \.(php.?|[ajk]sp[ax]?|[a-z]?html?|x|idc|log|cf[mc]?|mdb|do|(ms|f)?cgi|p(er)?lx?|nsf|dll|fts|exe|bat|dot|ini|com|pif|sh|sql|git|svn|yml)$) {
    return 404;
  }

  # opt-in to the future
  add_header "X-UA-Compatible" "IE=Edge,chrome=1";

  location @goiardi {
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_pass http://goiardi;
  }

  root <%= "#{node['goiardi']['webui']['deploy_location']}/current/public" %>;

  location / {
    try_files $uri @goiardi;
  }
  location /nginx_status {
    stub_status on;
    access_log  off;
    allow       127.0.0.1;
    deny        all;
  }
}
